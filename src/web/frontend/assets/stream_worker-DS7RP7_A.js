(function(){"use strict";let m,h,b,g;const f={canvas:null,ctx:null};let w=!1,c=null,y=!1,p=!1,x=!1,u=0,B=performance.now(),C=0,k=300;self.onmessage=async e=>{if(e.data.type==="init")p=e.data.enableMirrorEffectStream,x=e.data.enableMirrorEffectFrame,k=e.data.blurredbackgroundHighFramerate?50:300,m=e.data.canvases.stream,b=m.getContext("2d",{alpha:!1}),y=e.data.enableBlurredBackgroundStream,h=e.data.canvases.blurred,g=h.getContext("2d",{alpha:!1});else if(e.data.type==="frame"){if(w){u++;return}v(e.data.payload)}else e.data.type==="overlay"&&(console.log("update overlay to:",e.data.url),c?.bitmap&&c.bitmap.close(),e.data.url?c=await I(e.data.url):c=null)};const F=(e,a,n)=>{const r=c?c.bitmap.width:n.width,o=c?c.bitmap.height:n.height;if((e.width!==r||e.height!==o)&&(e.width=r,e.height=o,console.log(`set canvas size to ${r}x${o}`)),c){const{drawW:s,drawH:i,offsetX:t,offsetY:l}=M(n.width,n.height,c.transparent_bbox.width,c.transparent_bbox.height);p?a.setTransform(-1,0,0,1,e.width,0):a.resetTransform(),a.drawImage(n,c.transparent_bbox.x+t,c.transparent_bbox.y+l,s,i),x?a.setTransform(-1,0,0,1,e.width,0):a.resetTransform(),a.drawImage(c.bitmap,0,0)}else p?a.setTransform(-1,0,0,1,e.width,0):a.resetTransform(),a.drawImage(n,0,0)},T=(e,a,n)=>{const r=Math.ceil(n.width/16),o=Math.ceil(n.height/16);(e.width!==r||e.height!==o)&&(e.width=r,e.height=o,console.log(`set canvas size to ${r}x${o}`)),p?a.setTransform(-1,0,0,1,e.width,0):a.resetTransform(),a.drawImage(n,0,0,r,o)};async function v(e){w=!0;const a=e,n=performance.now();let r;try{const o=new Blob([a],{type:"image/jpeg"});if(r=await createImageBitmap(o),F(m,b,r),y){const s=performance.now();s-C>=k&&(T(h,g,r),C=s)}}catch(o){console.error(o)}finally{r&&r.close(),w=!1;const o=performance.now(),s=o-n;o-B>=2e3&&(console.log("drawCanvas took",s.toFixed(1),"ms, droppedFrameCount is ",u),B=o,u=0)}}async function I(e){try{const a=performance.now(),r=await(await fetch(e)).blob(),o=await createImageBitmap(r),s=await X(o),i=performance.now();return console.log("load overlay+calc transparency bbox took ",(i-a).toFixed(1),"ms, bbox is ",s),{bitmap:o,transparent_bbox:s}}catch(a){return console.error("Overlay load error:",a),null}}function M(e,a,n,r){const o=Math.max(n/e,r/a),s=e*o,i=a*o,t=(n-s)/2,l=(r-i)/2;return{drawW:s,drawH:i,offsetX:t,offsetY:l}}function S(e,a,n){let r=a,o=n,s=-1,i=-1;for(let t=0;t<n;t++)for(let l=0;l<a;l++)if(e[(t*a+l)*4+3]<255){o=t,t=n;break}for(let t=n-1;t>=0;t--)for(let l=0;l<a;l++)if(e[(t*a+l)*4+3]<255){i=t,t=-1;break}for(let t=0;t<a;t++)for(let l=o;l<=i;l++)if(e[(l*a+t)*4+3]<255){r=t,t=a;break}for(let t=a-1;t>=0;t--)for(let l=o;l<=i;l++)if(e[(l*a+t)*4+3]<255){s=t,t=-1;break}return{minX:r,minY:o,maxX:s,maxY:i}}async function X(e,a=8){const n=Math.ceil(e.width/a),r=Math.ceil(e.height/a),o=performance.now();f.canvas?(f.canvas.width!==n||f.canvas.height!==r)&&(f.canvas.width=n,f.canvas.height=r):(f.canvas=new OffscreenCanvas(n,r),f.ctx=f.canvas.getContext("2d",{willReadFrequently:!0,alpha:!0})),f.ctx.drawImage(e,0,0,n,r);const s=f.ctx.getImageData(0,0,n,r).data,i=performance.now(),{minX:t,minY:l,maxX:d,maxY:Y}=S(s,n,r),_=performance.now();return console.log("draw canvas for transparency detection took ",(i-o).toFixed(1)),console.log("detect transparent area took ",(_-i).toFixed(1)),{x:t*a,y:l*a,width:(d-t+1)*a,height:(Y-l+1)*a}}})();
