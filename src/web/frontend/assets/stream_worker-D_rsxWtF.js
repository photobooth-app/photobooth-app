(function(){"use strict";let w,h,d,u,m=null,i=null,p=!1,b=!1,g=performance.now();self.onmessage=async e=>{e.data.type==="init"?(w=e.data.canvases.stream,h=e.data.canvases.blurred,p=e.data.enableMirrorEffectStream,b=e.data.enableMirrorEffectFrame,d=w.getContext("2d",{alpha:!0}),u=h.getContext("2d",{alpha:!0})):e.data.type==="frame"?(m&&console.log("frame dropped"),m=e.data.payload,F()):e.data.type==="overlay"&&(console.log(e.data.url),e.data.url?i=await I(e.data.url):i=null)};const T=(e,t,o)=>{const r=i?i.bitmap.width:o.width,l=i?i.bitmap.height:o.height;if((e.width!==r||e.height!==l)&&(e.width=r,e.height=l,console.log(`set canvas size to ${r}x${l}`)),i){const{drawW:f,drawH:s,offsetX:a,offsetY:n}=X(o.width,o.height,i.transparent_bbox.width,i.transparent_bbox.height);p?t.setTransform(-1,0,0,1,e.width,0):t.resetTransform(),t.drawImage(o,i.transparent_bbox.x+a,i.transparent_bbox.y+n,f,s),b?t.setTransform(-1,0,0,1,e.width,0):t.resetTransform(),t.drawImage(i.bitmap,0,0)}else p?t.setTransform(-1,0,0,1,e.width,0):t.resetTransform(),t.drawImage(o,0,0)},M=(e,t,o)=>{const r=Math.ceil(o.width/32),l=Math.ceil(o.height/32);(e.width!==r||e.height!==l)&&(e.width=r,e.height=l,console.log(`set canvas size to ${r}x${l}`)),p?t.setTransform(-1,0,0,1,e.width,0):t.resetTransform(),t.drawImage(o,0,0,r,l)};async function F(){const e=m;if(m=null,!e)return;const t=performance.now();try{const o=new Blob([e],{type:"image/jpeg"}),r=await createImageBitmap(o);T(w,d,r),M(h,u,r),r.close()}catch(o){console.error(o)}finally{const o=performance.now(),r=o-t;o-g>=2e3&&(console.log("drawCanvas took",r.toFixed(1),"ms"),g=o)}}async function I(e){try{const t=performance.now(),r=await(await fetch(e)).blob(),l=await createImageBitmap(r),f=await _(l),s=performance.now();return console.log("load overlay+calc transparency bbox took ",(s-t).toFixed(1),"ms, bbox is ",f),{bitmap:l,transparent_bbox:f}}catch(t){return console.error("Overlay load error:",t),null}}function X(e,t,o,r){const l=Math.max(o/e,r/t),f=e*l,s=t*l,a=(o-f)/2,n=(r-s)/2;return{drawW:f,drawH:s,offsetX:a,offsetY:n}}function Y(e,t,o){let r=t,l=o,f=-1,s=-1;for(let a=0;a<o;a++)for(let n=0;n<t;n++)if(e[(a*t+n)*4+3]<255){l=a,a=o;break}for(let a=o-1;a>=0;a--)for(let n=0;n<t;n++)if(e[(a*t+n)*4+3]<255){s=a,a=-1;break}for(let a=0;a<t;a++)for(let n=l;n<=s;n++)if(e[(n*t+a)*4+3]<255){r=a,a=t;break}for(let a=t-1;a>=0;a--)for(let n=l;n<=s;n++)if(e[(n*t+a)*4+3]<255){f=a,a=-1;break}return{minX:r,minY:l,maxX:f,maxY:s}}function k(e,t,o){let r=t,l=o,f=-1,s=-1;for(let a=0;a<o;a++)for(let n=0;n<t;n++)e[(a*t+n)*4+3]<255&&(n<r&&(r=n),a<l&&(l=a),n>f&&(f=n),a>s&&(s=a));return{minX:r,minY:l,maxX:f,maxY:s}}async function _(e,t=8){const o=Math.ceil(e.width/t),r=Math.ceil(e.height/t),l=performance.now(),f=new OffscreenCanvas(o,r).getContext("2d",{willReadFrequently:!0});f.drawImage(e,0,0,o,r);const s=f.getImageData(0,0,o,r).data,a=performance.now();console.log((a-l).toFixed(1));const n=performance.now(),c=k(s,o,r),y=performance.now(),x=Y(s,o,r),E=performance.now();console.log(c,x),console.log((y-n).toFixed(1)),console.log((E-y).toFixed(1));const{minX:B,minY:C,maxX:O,maxY:S}=x;return{x:B*t,y:C*t,width:(O-B+1)*t,height:(S-C+1)*t}}})();
