(function(){"use strict";let m,p,g,b,h=null,n=null,w=!1,y=!1,x=performance.now();self.onmessage=async t=>{t.data.type==="init"?(m=t.data.canvases.stream,p=t.data.canvases.blurred,w=t.data.enableMirrorEffectStream,y=t.data.enableMirrorEffectFrame,g=m.getContext("2d",{alpha:!0}),b=p.getContext("2d",{alpha:!0})):t.data.type==="frame"?(h&&console.log("frame dropped"),h=t.data.payload,T()):t.data.type==="overlay"&&(console.log(t.data.url),t.data.url?n=await M(t.data.url):n=null)};const B=(t,e,a)=>{const r=n?n.bitmap.width:a.width,o=n?n.bitmap.height:a.height;if((t.width!==r||t.height!==o)&&(t.width=r,t.height=o,console.log(`set canvas size to ${r}x${o}`)),n){const{drawW:l,drawH:s,offsetX:i,offsetY:f}=I(a.width,a.height,n.transparent_bbox.width,n.transparent_bbox.height);w?e.setTransform(-1,0,0,1,t.width,0):e.resetTransform(),e.drawImage(a,n.transparent_bbox.x+i,n.transparent_bbox.y+f,l,s),y?e.setTransform(-1,0,0,1,t.width,0):e.resetTransform(),e.drawImage(n.bitmap,0,0)}else w?e.setTransform(-1,0,0,1,t.width,0):e.resetTransform(),e.drawImage(a,0,0)},C=(t,e,a)=>{const r=Math.ceil(a.width/32),o=Math.ceil(a.height/32);(t.width!==r||t.height!==o)&&(t.width=r,t.height=o,console.log(`set canvas size to ${r}x${o}`)),w?e.setTransform(-1,0,0,1,t.width,0):e.resetTransform(),e.drawImage(a,0,0,r,o)};async function T(){const t=h;if(h=null,!t)return;const e=performance.now();try{const a=new Blob([t],{type:"image/jpeg"}),r=await createImageBitmap(a);B(m,g,r),C(p,b,r),r.close()}catch(a){console.error(a)}finally{const a=performance.now(),r=a-e;a-x>=2e3&&(console.log("drawCanvas took",r.toFixed(1),"ms"),x=a)}}async function M(t){try{const e=performance.now(),r=await(await fetch(t)).blob(),o=await createImageBitmap(r),l=await F(o),s=performance.now();return console.log("load overlay+calc transparency bbox took ",(s-e).toFixed(1),"ms, bbox is ",l),{bitmap:o,transparent_bbox:l}}catch(e){return console.error("Overlay load error:",e),null}}function I(t,e,a,r){const o=Math.max(a/t,r/e),l=t*o,s=e*o,i=(a-l)/2,f=(r-s)/2;return{drawW:l,drawH:s,offsetX:i,offsetY:f}}async function F(t,e=5){const a=Math.ceil(t.width/e),r=Math.ceil(t.height/e),o=new OffscreenCanvas(a,r).getContext("2d",{willReadFrequently:!0});o.drawImage(t,0,0,a,r);const l=o.getImageData(0,0,a,r).data;let s=a,i=r,f=-1,u=-1;for(let d=0;d<r;d++)for(let c=0;c<a;c++)l[(d*a+c)*4+3]<128&&(c<s&&(s=c),d<i&&(i=d),c>f&&(f=c),d>u&&(u=d));return{x:s*e,y:i*e,width:(f-s+1)*e,height:(u-i+1)*e}}})();
